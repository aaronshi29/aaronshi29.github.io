<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nassau County Resources Map</title>

  <!-- MapLibre GL JS (CDN) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css"
    crossorigin="anonymous"
  />
  <script
    src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"
    crossorigin="anonymous"
  ></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    #map {
      position: fixed;
      inset: 0;
    }

    /* Floating panel */
    .panel {
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 10;
      width: min(360px, calc(100vw - 24px));
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      overflow: hidden;
      backdrop-filter: blur(6px);
    }
    .panel header {
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }
    .panel h1 {
      margin: 0;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.2px;
    }
    .panel .sub {
      margin-top: 6px;
      font-size: 12px;
      color: rgba(0,0,0,0.65);
      line-height: 1.3;
    }
    .panel .body {
      padding: 12px;
      display: grid;
      gap: 10px;
    }

    .row {
      display: grid;
      gap: 6px;
    }
    label {
      font-size: 12px;
      font-weight: 600;
      color: rgba(0,0,0,0.8);
    }
    input[type="text"] {
      width: 100%;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.18);
      outline: none;
      font-size: 13px;
      background: white;
    }
    input[type="text"]:focus {
      border-color: rgba(0,0,0,0.35);
      box-shadow: 0 0 0 3px rgba(0,0,0,0.07);
    }

    .cats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 10px;
      align-items: start;
    }
    .cat {
      display: flex;
      gap: 8px;
      align-items: center;
      user-select: none;
      font-size: 12px;
      color: rgba(0,0,0,0.78);
    }
    .swatch {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.18);
      flex: 0 0 auto;
    }
    .btns {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    button {
      appearance: none;
      border: 1px solid rgba(0,0,0,0.18);
      background: white;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
      cursor: pointer;
    }
    button:hover {
      border-color: rgba(0,0,0,0.35);
    }

    .status {
      font-size: 12px;
      color: rgba(0,0,0,0.65);
    }

    /* Popup styling */
    .maplibregl-popup-content {
      border-radius: 12px;
      padding: 12px 12px 10px;
      min-width: 240px;
      max-width: 360px;
      box-shadow: 0 10px 28px rgba(0,0,0,0.2);
    }
    .p-title {
      font-weight: 800;
      margin: 0 0 6px;
      font-size: 14px;
      line-height: 1.25;
    }
    .p-line {
      margin: 6px 0;
      font-size: 12px;
      color: rgba(0,0,0,0.8);
      line-height: 1.35;
    }
    .p-line b {
      color: rgba(0,0,0,0.9);
    }
    .p-links a {
      word-break: break-word;
    }

    /* Small screen: panel bottom */
    @media (max-width: 640px) {
      .panel {
        top: auto;
        left: 12px;
        right: 12px;
        bottom: 12px;
        width: auto;
      }
      .cats { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="panel" role="region" aria-label="Map filters">
    <header>
      <h1>Nassau County Resources</h1>
      <div class="sub">Filter by category and search by name/address. Click a point for details.</div>
    </header>
    <div class="body">
      <div class="row">
        <label for="search">Search</label>
        <input id="search" type="text" placeholder="e.g., 'Uniondale', 'legal', 'food'" />
      </div>

      <div class="row">
        <label>Categories</label>
        <div class="cats" id="cats"></div>
      </div>

      <div class="btns">
        <button id="selectAll" type="button">Select all</button>
        <button id="selectNone" type="button">Select none</button>
        <button id="zoomToData" type="button">Zoom to data</button>
      </div>

      <div class="status" id="status">Loading dataâ€¦</div>
    </div>
  </div>

  <script>
    // ---- Configuration ----
    const GEOJSON_URL = "./nassau_county.geojson";
    const SOURCE_ID = "resources";
    const LAYER_POINTS = "resources-points";
    const LAYER_LABELS = "resources-labels";

    // Category styling (edit freely)
    const CATEGORY_COLORS = {
      "Shelter / Housing": "#2E86FF",
      "Food bank / food assistance": "#18A558",
      "Medical service": "#D7263D",
      "Legal service": "#8E44AD",
      "__default__": "#4B5563"
    };

    const ALL_CATEGORIES = Object.keys(CATEGORY_COLORS).filter(k => k !== "__default__");

    // ---- Map init ----
    const map = new maplibregl.Map({
      container: "map",
      // Public demo style. Swap for your own style if needed.
      style: "https://demotiles.maplibre.org/style.json",
      center: [-73.58, 40.74], // Nassau-ish default
      zoom: 10.2
    });

    map.addControl(new maplibregl.NavigationControl({ visualizePitch: true }), "top-right");
    map.addControl(new maplibregl.ScaleControl({ maxWidth: 120, unit: "imperial" }), "bottom-left");

    // ---- UI state ----
    const state = {
      selectedCategories: new Set(ALL_CATEGORIES),
      search: ""
    };

    // Build category checklist UI
    const catsEl = document.getElementById("cats");
    function makeCatRow(cat) {
      const wrap = document.createElement("label");
      wrap.className = "cat";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = true;
      cb.dataset.cat = cat;

      const sw = document.createElement("span");
      sw.className = "swatch";
      sw.style.background = CATEGORY_COLORS[cat] || CATEGORY_COLORS.__default__;

      const text = document.createElement("span");
      text.textContent = cat;

      wrap.appendChild(cb);
      wrap.appendChild(sw);
      wrap.appendChild(text);

      cb.addEventListener("change", () => {
        if (cb.checked) state.selectedCategories.add(cat);
        else state.selectedCategories.delete(cat);
        applyFilter();
      });

      return wrap;
    }

    ALL_CATEGORIES.forEach(cat => catsEl.appendChild(makeCatRow(cat)));

    document.getElementById("selectAll").addEventListener("click", () => {
      state.selectedCategories = new Set(ALL_CATEGORIES);
      document.querySelectorAll('#cats input[type="checkbox"]').forEach(cb => cb.checked = true);
      applyFilter();
    });

    document.getElementById("selectNone").addEventListener("click", () => {
      state.selectedCategories = new Set();
      document.querySelectorAll('#cats input[type="checkbox"]').forEach(cb => cb.checked = false);
      applyFilter();
    });

    document.getElementById("search").addEventListener("input", (e) => {
      state.search = (e.target.value || "").trim();
      applyFilter();
    });

    // ---- Helpers ----
    function escHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function parseUrls(urlField) {
      // Your GeoJSON stores URLs in a single string separated by ";" sometimes.
      if (!urlField) return [];
      return String(urlField)
        .split(";")
        .map(s => s.trim())
        .filter(Boolean);
    }

    function updateStatus(text) {
      document.getElementById("status").textContent = text;
    }

    function categoryColorExpression() {
      // MapLibre style expression: match Category to color
      const expr = ["match", ["get", "Category"]];
      for (const cat of ALL_CATEGORIES) {
        expr.push(cat, CATEGORY_COLORS[cat] || CATEGORY_COLORS.__default__);
      }
      expr.push(CATEGORY_COLORS.__default__);
      return expr;
    }

    function buildFilterExpression() {
      const clauses = ["all"];

      // Category filter
      const selected = Array.from(state.selectedCategories);
      if (selected.length === 0) {
        // show none
        clauses.push(["==", ["get", "Category"], "__nope__"]);
      } else {
        clauses.push(["in", ["get", "Category"], ["literal", selected]]);
      }

      // Search filter (substring match across common fields)
      const q = state.search.trim().toLowerCase();
      if (q.length > 0) {
        const qExpr = ["literal", q];
        const contains = (field) => [
          "!=", ["index-of", qExpr, ["downcase", ["to-string", ["coalesce", ["get", field], ""]]]], -1
        ];
        clauses.push(["any",
          contains("Name"),
          contains("Address"),
          contains("Short description"),
          contains("Opening time"),
          contains("Category")
        ]);
      }

      return clauses;
    }

    function applyFilter() {
      if (!map.getLayer(LAYER_POINTS)) return;
      const filter = buildFilterExpression();
      map.setFilter(LAYER_POINTS, filter);
      map.setFilter(LAYER_LABELS, filter);

      const selCount = state.selectedCategories.size;
      const q = state.search.trim();
      updateStatus(`Filters: ${selCount}/${ALL_CATEGORIES.length} categories${q ? `, search="${q}"` : ""}`);
    }

    function fitToData() {
      const src = map.getSource(SOURCE_ID);
      const data = src?._data; // MapLibre internal reference; ok for simple fit.
      if (!data || !data.features || data.features.length === 0) return;

      const coords = data.features
        .map(f => f.geometry && f.geometry.type === "Point" ? f.geometry.coordinates : null)
        .filter(Boolean);

      if (coords.length === 0) return;

      let minX = coords[0][0], minY = coords[0][1], maxX = coords[0][0], maxY = coords[0][1];
      for (const [x,y] of coords) {
        minX = Math.min(minX, x); minY = Math.min(minY, y);
        maxX = Math.max(maxX, x); maxY = Math.max(maxY, y);
      }

      map.fitBounds([[minX, minY], [maxX, maxY]], { padding: 60, duration: 900 });
    }

    document.getElementById("zoomToData").addEventListener("click", fitToData);

    // ---- Load GeoJSON + add layers ----
    map.on("load", async () => {
      try {
        const resp = await fetch(GEOJSON_URL, { cache: "no-store" });
        if (!resp.ok) throw new Error(`Failed to fetch ${GEOJSON_URL} (${resp.status})`);
        const geojson = await resp.json();

        map.addSource(SOURCE_ID, {
          type: "geojson",
          data: geojson
        });

        // Points
        map.addLayer({
          id: LAYER_POINTS,
          type: "circle",
          source: SOURCE_ID,
          paint: {
            "circle-radius": [
              "interpolate", ["linear"], ["zoom"],
              8, 4,
              12, 7,
              15, 10
            ],
            "circle-color": categoryColorExpression(),
            "circle-opacity": 0.85,
            "circle-stroke-width": 1.2,
            "circle-stroke-color": "rgba(0,0,0,0.35)"
          }
        });

        // Labels (appear at higher zoom)
        map.addLayer({
          id: LAYER_LABELS,
          type: "symbol",
          source: SOURCE_ID,
          minzoom: 12.5,
          layout: {
            "text-field": ["get", "Name"],
            "text-size": 12,
            "text-offset": [0, 1.1],
            "text-anchor": "top",
            "text-optional": true
          },
          paint: {
            "text-halo-color": "rgba(255,255,255,0.95)",
            "text-halo-width": 1.2
          }
        });

        // Hover cursor
        map.on("mouseenter", LAYER_POINTS, () => map.getCanvas().style.cursor = "pointer");
        map.on("mouseleave", LAYER_POINTS, () => map.getCanvas().style.cursor = "");

        // Popups
        map.on("click", LAYER_POINTS, (e) => {
          const f = e.features && e.features[0];
          if (!f) return;

          const p = f.properties || {};
          const urls = parseUrls(p["Primary source URL(s)"]);

          const html = `
            <div>
              <div class="p-title">${escHtml(p.Name || "Resource")}</div>
              <div class="p-line"><b>Category:</b> ${escHtml(p.Category || "")}</div>
              ${p.Address ? `<div class="p-line"><b>Address:</b> ${escHtml(p.Address)}</div>` : ""}
              ${p["Opening time"] ? `<div class="p-line"><b>Hours:</b> ${escHtml(p["Opening time"])}</div>` : ""}
              ${p["Capacity (if known)"] ? `<div class="p-line"><b>Capacity:</b> ${escHtml(p["Capacity (if known)"])}</div>` : ""}
              ${p["Short description"] ? `<div class="p-line"><b>Notes:</b> ${escHtml(p["Short description"])}</div>` : ""}
              ${
                urls.length
                  ? `<div class="p-line p-links"><b>Sources:</b><br>${urls
                      .map(u => `<a href="${escHtml(u)}" target="_blank" rel="noopener noreferrer">${escHtml(u)}</a>`)
                      .join("<br>")}</div>`
                  : ""
              }
            </div>
          `;

          // Use feature geometry coordinate for accurate placement
          const lngLat = (f.geometry && f.geometry.type === "Point") ? f.geometry.coordinates : e.lngLat;

          new maplibregl.Popup({ closeButton: true, closeOnClick: true, maxWidth: "380px" })
            .setLngLat(lngLat)
            .setHTML(html)
            .addTo(map);
        });

        // Initial fit and filter
        updateStatus(`Loaded ${geojson.features?.length ?? 0} resources.`);
        fitToData();
        applyFilter();

      } catch (err) {
        console.error(err);
        updateStatus(`Error: ${err.message}`);
        alert(`Could not load GEOJSON: ${err.message}\n\nMake sure nassau_county.geojson is in the same folder as index.HTML and you're serving via a local web server (not file://).`);
      }
    });

    // Note: Fetching local files usually requires serving via HTTP.
    // For example:
    //   python3 -m http.server 8000
    // then open:
    //   http://localhost:8000/index.HTML
  </script>
</body>
</html>
